<script>
  (function(){
    function log(){ try{ console.log('[index]', ...arguments); }catch{} }
    log('boot', { href: location.href, when: new Date().toISOString(), cookie: document.cookie });

    // Log all form submissions on the page, mask passwords
    document.addEventListener('submit', (e) => {
      const fd = new FormData(e.target);
      const entries = {};
      for (const [k,v] of fd.entries()) entries[k] = k.toLowerCase().includes('pass') ? '***' : String(v);
      log('form:submit', { target: e.target.tagName, entries });
    }, true);

    // Wrap fetch to log every /api/auth/* call + surface server debug headers
    const _fetch = window.fetch;
    window.fetch = async function(input, init){
      const url = (typeof input === 'string') ? input : (input?.url || '');
      const isAuth = url.includes('/api/auth/');
      if (isAuth) log('fetch:req', { url, method: init?.method || 'GET', creds: init?.credentials, headers: init?.headers });
      const resp = await _fetch.apply(this, arguments);
      if (isAuth) {
        const debug = resp.headers.get('x-rp-debug');
        log('fetch:resp', { url, ok: resp.ok, status: resp.status, debug });
        // Also try to peek at JSON body to get `debug` field when present
        try {
          const clone = resp.clone();
          const text = await clone.text();
          let data = null;
          try { data = text ? JSON.parse(text) : null; } catch {}
          if (data && data.debug) log('fetch:resp:json.debug', data.debug);
        } catch {}
      }
      return resp;
    };
  })();
</script>
